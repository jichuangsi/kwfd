<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Agora Web Sample</title>
    <link rel="stylesheet" href="assets/style/index.css">
    <link rel="stylesheet" href="assets/style/watch.css">
    <script src="AgoraRTCSDK-2.7.0.js"></script>
    <script src="vendor/jquery.js"></script>
</head>

<body>
        <div class="logo fl"><img src="./assets/images/logo.png" alt=""></div>

    <!--style>
    .video__box{width:910px; margin:0 auto; overflow:hidden;}
    .video__main{ width:810px; height:607px;float:left }
    .video__list{ width:200px; height:607px; float:left;}
    .video__item{ width:200px; height:174px; hei background:url(/img/icon_live.png) center center no-repeat; }
    </style>
    <div class="video__main">
    </div>
    <div class="video__list">
        <div class="video__item"></div>
        <div id="video" class="video__item">
            <div id="agora_local"></div>
        </div>
    </div-->

    <div id="video" onmousemove="videofocus()" onmouseout="videoblur()">
        <div id="agora_local" style="width:100%;height:100%;display:inline-block;"></div>
        <div class="UserCount">在线人数：<span>0</span>人</div>
        <div class="nav">
            <div>
                <span class="s1" onclick="leave()"></span>
                <span class="s2" onclick="CameraStop()"></span>
                <span class="s3" onclick="MicrophoneStop()"></span>
                <!-- <span class="s4" onclick="share()"></span> -->
                <!-- <span class="s5" onclick="Same()"></span> -->
                <span class="s6" onclick="Rotate()"></span>
            </div>
        </div>
    </div>

    <script language="javascript">
        if (!AgoraRTC.checkSystemRequirements()) {
            alert("Your browser does not support WebRTC!");
        }
        /* select Log type */
        // AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.NONE);
        // AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.ERROR);
        // AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.WARNING);
        // AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.INFO);  
        // AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.DEBUG);

        /* simulated data to proof setLogLevel() */
        AgoraRTC.Logger.error('this is error');
        AgoraRTC.Logger.warning('this is warning');
        AgoraRTC.Logger.info('this is info');
        AgoraRTC.Logger.debug('this is debug');

        var client, localStream, camera, microphone;
        var Camera = 1
        var Microphone = 1
        var rotate = 0
        var audioSelect = sessionStorage.getItem('audioSelect')
        var videoSelect = sessionStorage.getItem('videoSelect')
        var role = sessionStorage.getItem('role')
        var room = sessionStorage.getItem('room')
        var appid = sessionStorage.getItem('appid')
                
        if(role == '2'){
            $('.s2').remove()
            $('.s3').remove()
            $('.s5').remove()
        }
        function join() {
            var channel_key = null;

            client = AgoraRTC.createClient({
                mode: 'live'
            });
            client.init(appid, function () {
                console.log("AgoraRTC client initialized");
                client.join(channel_key, room, null, function (uid) {
                    console.log("User " + uid + " join channel successfully");

                        camera = videoSelect;
                        microphone = audioSelect;
                        localStream = AgoraRTC.createStream({
                            streamID: uid,
                            audio: true,
                            cameraId: camera,
                            microphoneId: microphone,
                            video: true,
                            screen: false
                        });
                        //localStream = AgoraRTC.createStream({streamID: uid, audio: false, cameraId: camera, microphoneId: microphone, video: false, screen: true, extensionId: 'minllpmhdgpndnkomcoccfekfegnlikg'});
                        // if (document.getElementById("video").checked) {
                            localStream.setVideoProfile('720p_3');

                        // }
             
        // console.log(localStream.SessionStats())
                        client.getSessionStats((state)=>{
                            $('.UserCount>span').text(state.UserCount-1)
                        })
     
                        // The user has granted access to the camera and mic.
                        localStream.on("accessAllowed", function () {
                            console.log("accessAllowed");
                        });

                        // if(role == '老师'){
                        // The user has denied access to the camera and mic.
                        localStream.on("accessDenied", function () {
                            console.log("accessDenied");
                        });

                        localStream.init(function () {
                            console.log("getUserMedia successfully");
                            localStream.play('agora_local');
                            if(role == '4'){
                                client.publish(localStream, function (err) {
                                    console.log("Publish local stream error: " + err);
                                });

                                client.on('stream-published', function (evt) {
                                    console.log("Publish local stream successfully");
                                });
                            }
                            else {
                                localStream.stop('agora_local');
                            }
                            
                        }, function (err) {
                            console.log("getUserMedia failed", err);
                        });
                        // }
                }, function (err) {
                    console.log("Join channel failed", err);
                });
            }, function (err) {
                console.log("AgoraRTC client init failed", err);
            });

            channelKey = "";
            client.on('error', function (err) {
                console.log("Got error msg:", err.reason);
                if (err.reason === 'DYNAMIC_KEY_TIMEOUT') {
                    client.renewChannelKey(channelKey, function () {
                        console.log("Renew channel key successfully");
                    }, function (err) {
                        console.log("Renew channel key failed: ", err);
                    });
                }
            });


            client.on('stream-added', function (evt) {
                var stream = evt.stream;
                
                
                console.log("New stream added: " + stream.getId());
                console.log("Subscribe ", stream);
                client.subscribe(stream, function (err) {
                    console.log("Subscribe stream failed", err);
                });
            });

            if(role == '2'){
                client.on('stream-subscribed', function (evt) {
                    var stream = evt.stream;
                    console.log("Subscribe remote stream successfully: " + stream.getId());
                    if ($('div#video #agora_remote' + stream.getId()).length === 0) {
                        $('div#video').append('<div id="agora_remote' + stream.getId() +
                            '" style="position: absolute;right:0px;top:0px;width:100%;height:100%;display:inline-block;"></div>');
                    }
                    // stream.stop('agora_local');
                    stream.play('agora_remote' + stream.getId());
                    sessionStorage.setItem('streamID','agora_remote' + stream.getId())
                });
            }

            client.on('stream-removed', function (evt) {
                var stream = evt.stream;
                stream.stop();
                $('#agora_remote' + stream.getId()).remove();
                console.log("Remote stream is removed " + stream.getId());
            });

            client.on('peer-leave', function (evt) {
                var stream = evt.stream;
                if (stream) {
                    stream.stop();
                    $('#agora_remote' + stream.getId()).remove();
                    console.log(evt.uid + " leaved from this channel");
                }
            });
        }

        function leave() {
            client.leave(function () {
                console.log("Leavel channel successfully");
            }, function (err) {
                console.log("Leave channel failed");
            });
        }
        function CameraStop(){
                if(Camera == 1){
                    Camera = 2
                    localStream.muteVideo();
                    $('.s2')[0].style.backgroundPosition = '-35px -108px'
                }else {
                    Camera = 1
                    localStream.unmuteVideo();
                    $('.s2')[0].style.backgroundPosition = '-167px -108px'
                }
        }
        function MicrophoneStop(){
            if(Microphone == 1){
                    Microphone = 2
                    localStream.muteAudio();
                    $('.s3')[0].style.backgroundPosition = '-36px -189px'
                }else {
                    Microphone = 1
                    localStream.unmuteAudio();
                    $('.s3')[0].style.backgroundPosition = '-169px -189px'
                }
        }
        function videofocus(){
            $('.nav')[0].style.bottom = '0px'
        }
        function videoblur(){
            $('.nav')[0].style.bottom = '-60px'
        }
        function Rotate (){
            rotate -= 90
            $('#video').find('video')[0].style.transform = "rotate("+rotate+"deg) rotateY(180deg)"
        }


        //audioSelect.onchange = getDevices;
        //videoSelect.onchange = getDevices;
        join();
    </script>
</body>

</html>